CREATE TABLE IF NOT EXISTS produtor_rural(
	nome VARCHAR(100) NOT NULL,
	cpf BIGINT,
	sexo CHAR(1),
	dt_nasc DATE,
	endereco VARCHAR(250),

	CONSTRAINT pk_produtor_rural_cpf PRIMARY KEY (cpf), 
	CONSTRAINT chk_produtor_rural_sexo CHECK (sexo IN ('m', 'f'))
);

CREATE TABLE IF NOT EXISTS propriedade(
	id SERIAL, 
	nome VARCHAR(100) NOT NULL,
	endereco VARCHAR(250) NOT NULL,
	area DECIMAL(10,2), 

	CONSTRAINT pk_propriedade PRIMARY KEY(id),
	CONSTRAINT uk_propriedade_nome_endereco UNIQUE(nome, endereco)
);

CREATE TABLE IF NOT EXISTS produtor_propriedade(
	cpf_produtor_rural BIGINT, 
	id_propriedade INT,

	CONSTRAINT pk_produtor_propriedade PRIMARY KEY (cpf_produtor_rural, id_propriedade),

	CONSTRAINT fk_produtor_propriedade_produtor FOREIGN KEY (cpf_produtor_rural)
	REFERENCES produtor_rural(cpf) ON DELETE CASCADE,
	
	CONSTRAINT fk_produtor_propriedade_propriedade FOREIGN KEY (id_propriedade)
	REFERENCES propriedade(id) ON DELETE CASCADE 
);

CREATE TABLE IF NOT EXISTS talhao(
	id_propriedade INT, 
	id_talhao INT, -- tirei o serial daqui por que assim esse numero seria global para todas as propriedades. nao eh isso o que eu quero.      
	area DECIMAL(10,2), 

	CONSTRAINT pk_talhao PRIMARY KEY (id_propriedade, id_talhao),

	CONSTRAINT fk_talhao_propriedade FOREIGN KEY (id_propriedade)
	REFERENCES propriedade(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS safra(
	id_safra SERIAL, 
	id_propriedade INT, 
	id_talhao INT,      
	dt_plantio DATE,
	dt_colheita DATE,
	producao DECIMAL(10, 2), 

	CONSTRAINT pk_safra PRIMARY KEY (id_safra),

	CONSTRAINT fk_safra_propriedade FOREIGN KEY (id_propriedade)
	REFERENCES propriedade(id) ON DELETE CASCADE, 

	CONSTRAINT fk_safra_talhao FOREIGN KEY (id_propriedade, id_talhao)
	REFERENCES talhao(id_propriedade, id_talhao) ON DELETE CASCADE, 

	CONSTRAINT uk_safra UNIQUE(id_propriedade, id_talhao, dt_plantio, dt_colheita)
);